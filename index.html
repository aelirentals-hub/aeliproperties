import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { MapContainer, TileLayer, Marker, Popup, Circle } from 'react-leaflet';
import { motion } from 'framer-motion';
import { ArrowLeft, MapPin, Building2, ShoppingBag, HeartPulse, GraduationCap, Store } from 'lucide-react';
import CountdownBadge from '../components/property/CountdownBadge';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';

// Fix for default marker icons in Leaflet
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

// Custom property marker
const propertyIcon = new L.DivIcon({
  className: 'custom-marker',
  html: `<div style="background: #C5A059; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
      <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
  </div>`,
  iconSize: [36, 36],
  iconAnchor: [18, 36],
  popupAnchor: [0, -36],
});

// Nearby places markers
const createPlaceIcon = (color) => new L.DivIcon({
  className: 'custom-marker',
  html: `<div style="background: ${color}; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
    <div style="width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
  </div>`,
  iconSize: [28, 28],
  iconAnchor: [14, 28],
  popupAnchor: [0, -28],
});

export default function MapView() {
  const [selectedProperty, setSelectedProperty] = useState(null);
  const [showNearby, setShowNearby] = useState(true);

  const { data: properties = [], isLoading } = useQuery({
    queryKey: ['properties'],
    queryFn: async () => {
      const props = await base44.entities.Property.list('-created_date');
      return props.map(p => ({
        id: p.id,
        ...p.data,
        created_date: p.created_date
      }));
    },
  });

  // Center of Chiang Mai
  const chiangMaiCenter = [18.7883, 98.9853];

  // Nearby highlights
  const nearbyPlaces = [
    { name: 'Maya Lifestyle Shopping Center', lat: 18.8024, lng: 98.9671, type: 'shopping', color: '#E91E63' },
    { name: 'Central Festival Chiang Mai', lat: 18.8074, lng: 99.0189, type: 'shopping', color: '#E91E63' },
    { name: 'Bangkok Hospital Chiang Mai', lat: 18.7845, lng: 98.9817, type: 'hospital', color: '#4CAF50' },
    { name: 'Panyaden International School', lat: 18.7352, lng: 98.9345, type: 'school', color: '#2196F3' },
    { name: '7-Eleven (Multiple Locations)', lat: 18.7920, lng: 98.9880, type: 'convenience', color: '#FF9800' },
    { name: 'Tops Daily', lat: 18.7950, lng: 98.9750, type: 'grocery', color: '#9C27B0' },
  ];

  const placeTypeIcons = {
    shopping: ShoppingBag,
    hospital: HeartPulse,
    school: GraduationCap,
    convenience: Store,
    grocery: Store,
  };

  return (
    <div className="min-h-screen bg-[#F9F7F2]">
      {/* Header */}
      <div className="fixed top-0 left-0 right-0 z-50 glass shadow-lg">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <Link
                to={createPageUrl('Home')}
                className="flex items-center gap-2 text-[#2C2C2C] hover:text-[#C5A059] transition-colors"
              >
                <ArrowLeft className="w-5 h-5" />
                <span className="hidden sm:inline">Back</span>
              </Link>
              <div className="h-6 w-px bg-[#2C2C2C]/20" />
              <h1 className="font-['Playfair_Display'] text-xl font-bold text-[#2C2C2C]">
                Property Map
              </h1>
            </div>

            {/* Toggle Nearby */}
            <button
              onClick={() => setShowNearby(!showNearby)}
              className={`px-4 py-2 rounded-lg font-medium transition-all ${
                showNearby
                  ? 'bg-[#C5A059] text-white'
                  : 'bg-white text-[#2C2C2C]/70'
              }`}
            >
              <MapPin className="w-4 h-4 inline mr-2" />
              Nearby Highlights
            </button>
          </div>
        </div>
      </div>

      {/* Map Container */}
      <div className="pt-20 h-screen">
        <MapContainer
          center={chiangMaiCenter}
          zoom={14}
          style={{ height: 'calc(100vh - 80px)', width: '100%' }}
          className="z-10"
        >
          <TileLayer
            url="https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"
            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          />

          {/* Property Markers */}
          {properties.map((property) => (
            <Marker
              key={property.id}
              position={[property.latitude || 18.7883, property.longitude || 98.9853]}
              icon={propertyIcon}
              eventHandlers={{
                click: () => setSelectedProperty(property),
              }}
            >
              <Popup className="property-popup">
                <div className="p-1 min-w-[200px]">
                  <h3 className="font-semibold text-[#2C2C2C] mb-1">{property.name}</h3>
                  <p className="text-sm text-[#2C2C2C]/60 mb-2">{property.type}</p>
                  <div className="mb-3">
                    <CountdownBadge checkoutDate={property.checkout_date} />
                  </div>
                  <p className="text-[#C5A059] font-bold mb-3">
                    ฿{(property.price_1_mo || 11000).toLocaleString()}/mo
                  </p>
                  <Link
                    to={createPageUrl('PropertyDetail') + `?id=${property.id}`}
                    className="block text-center py-2 bg-[#2C2C2C] text-white text-sm rounded-lg hover:bg-[#3C3C3C] transition-colors"
                  >
                    View Details
                  </Link>
                </div>
              </Popup>
            </Marker>
          ))}

          {/* Nearby Places Markers */}
          {showNearby && nearbyPlaces.map((place, index) => (
            <Marker
              key={index}
              position={[place.lat, place.lng]}
              icon={createPlaceIcon(place.color)}
            >
              <Popup>
                <div className="p-1">
                  <h4 className="font-medium text-[#2C2C2C]">{place.name}</h4>
                  <p className="text-xs text-[#2C2C2C]/60 capitalize">{place.type}</p>
                </div>
              </Popup>
            </Marker>
          ))}
        </MapContainer>
      </div>

      {/* Legend */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        className="fixed bottom-6 left-6 glass rounded-2xl p-4 shadow-xl z-20"
      >
        <h4 className="font-semibold text-[#2C2C2C] mb-3 text-sm">Legend</h4>
        <div className="space-y-2">
          <div className="flex items-center gap-2 text-xs">
            <div className="w-5 h-5 bg-[#C5A059] rounded-full" />
            <span className="text-[#2C2C2C]/70">Aeli Property</span>
          </div>
          {showNearby && (
            <>
              <div className="flex items-center gap-2 text-xs">
                <div className="w-4 h-4 bg-[#E91E63] rounded-full" />
                <span className="text-[#2C2C2C]/70">Shopping</span>
              </div>
              <div className="flex items-center gap-2 text-xs">
                <div className="w-4 h-4 bg-[#4CAF50] rounded-full" />
                <span className="text-[#2C2C2C]/70">Hospital</span>
              </div>
              <div className="flex items-center gap-2 text-xs">
                <div className="w-4 h-4 bg-[#2196F3] rounded-full" />
                <span className="text-[#2C2C2C]/70">School</span>
              </div>
              <div className="flex items-center gap-2 text-xs">
                <div className="w-4 h-4 bg-[#FF9800] rounded-full" />
                <span className="text-[#2C2C2C]/70">Convenience</span>
              </div>
            </>
          )}
        </div>
      </motion.div>

      {/* Property List Sidebar */}
      <motion.div
        initial={{ opacity: 0, x: 20 }}
        animate={{ opacity: 1, x: 0 }}
        className="fixed bottom-6 right-6 glass rounded-2xl p-4 shadow-xl z-20 max-w-xs max-h-[60vh] overflow-y-auto hidden lg:block"
      >
        <h4 className="font-['Playfair_Display'] font-bold text-[#2C2C2C] mb-4">All Properties</h4>
        <div className="space-y-3">
          {properties.map((property) => {
            const isAvailable = new Date(property.checkout_date) <= new Date();
            return (
              <Link
                key={property.id}
                to={createPageUrl('PropertyDetail') + `?id=${property.id}`}
                className="block p-3 bg-white/50 rounded-xl hover:bg-white transition-colors"
              >
                <div className="flex justify-between items-start mb-1">
                  <h5 className="font-medium text-[#2C2C2C] text-sm">{property.name}</h5>
                  {isAvailable && (
                    <span className="text-[10px] px-2 py-0.5 bg-[#C5A059] text-white rounded-full">
                      Available
                    </span>
                  )}
                </div>
                <p className="text-xs text-[#2C2C2C]/60 mb-1">{property.type}</p>
                <p className="text-sm text-[#C5A059] font-semibold">
                  ฿{(property.price_1_mo || 11000).toLocaleString()}/mo
                </p>
              </Link>
            );
          })}
        </div>
      </motion.div>
    </div>
  );
}
